var vZero=Class.create();vZero.prototype={initialize:function(code,clientToken,threeDSecure,hostedFields,billingName,billingPostcode,quoteUrl,tokenizeUrl,clientTokenUrl){this.code=code,this.clientToken=clientToken||!1,this.clientTokenUrl=clientTokenUrl,this.threeDSecure=threeDSecure,this.hostedFields=hostedFields,billingName&&(this.billingName=billingName),billingPostcode&&(this.billingPostcode=billingPostcode),this.billingCountryId=!1,quoteUrl&&(this.quoteUrl=quoteUrl),tokenizeUrl&&(this.tokenizeUrl=tokenizeUrl),this._hostedFieldsTokenGenerated=!1,this.acceptedCards=!1,this._hostedFieldsTimeout=!1,this._updateDataCallbacks=[],this._updateDataTimeout=null,this.client=!1,this.threeDSpecificCountries=!1,this.threeDCountries=[],this.threeDSecureFailedAction=0,this.supportedCards=[],this.cardType=!1,this.initEvents()},initEvents:function(){this.events={onBeforeUpdateData:[],onAfterUpdateData:[],onHandleAjaxRequest:[],integration:{onInit:[],onInitDefaultMethod:[],onInitSavedMethods:[],onShowHideOtherMethod:[],onCheckSavedOther:[],onPaymentMethodSwitch:[],onReviewInit:[],onBeforeSubmit:[],onAfterSubmit:[],onObserveAjaxRequests:[]}}},setKount:function(environment,kountId){this.kountEnvironment=environment,""!=kountId&&(this.kountId=kountId)},setSupportedCards:function(cardTypes){"string"==typeof cardTypes&&(cardTypes=cardTypes.split(",")),this.supportedCards=cardTypes},setThreeDCountries:function(countries){"string"==typeof countries&&(countries=countries.split(",")),this.threeDSpecificCountries=!0,this.threeDCountries=countries},setThreeDFailedAction:function(action){this.threeDSecureFailedAction=action},observeEvent:function(paths,eventFn,params){Array.isArray(paths)||(paths=[paths]),paths.each(function(path){var event=this._resolveEvent(path);void 0===event?console.warn("Event for "+path+" does not exist."):event.push({fn:eventFn,params:params})}.bind(this))},fireEvent:function(caller,path,params){var events=this._resolveEvent(path);void 0!==events&&0<events.length&&events.each(function(event){if("function"==typeof event.fn){var arguments=[params];"object"==typeof event.params&&arguments.push(event.params),event.fn.apply(caller,arguments)}})},_resolveEvent:function(path){return path.split(".").reduce(function(prev,curr){return prev?prev[curr]:void 0},this.events)},getClientToken:function(callbackFn){return!1!==this.clientToken?callbackFn(this.clientToken):window.braintreeClientToken?callbackFn(window.braintreeClientToken):void new Ajax.Request(this.clientTokenUrl,{method:"get",onSuccess:function(transport){if(transport&&(transport.responseJSON||transport.responseText)){var response=this._parseTransportAsJson(transport);if(1==response.success&&"string"==typeof response.client_token)return this.clientToken=response.client_token,window.braintreeClientToken=response.client_token,callbackFn(this.clientToken);console.error("We were unable to retrieve a client token from the server to initialize the Braintree flow."),response.error&&console.error(response.error)}}.bind(this),onFailure:function(){console.error("We were unable to retrieve a client token from the server to initialize the Braintree flow.")}.bind(this)})},getClient:function(callbackFn){!1!==this.client?"function"==typeof callbackFn&&callbackFn(this.client):this.getClientToken(function(clientToken){braintree.client.create({authorization:clientToken},function(clientErr,clientInstance){clientErr?console.error(clientErr):(this.client=clientInstance,callbackFn(this.client))}.bind(this))})},initHostedFields:function(integration){return!(0<$$('iframe[name^="braintree-"]').length)&&(null!==$("braintree-hosted-submit")&&(this.integration=integration,this._hostedFieldsTokenGenerated=!1,clearTimeout(this._hostedFieldsTimeout),void(this._hostedFieldsTimeout=setTimeout(function(){if(!1!==this._hostedIntegration)try{this._hostedIntegration.teardown(function(){this._hostedIntegration=!1,this.setupHostedFieldsClient()}.bind(this))}catch(e){this.setupHostedFieldsClient()}else this.setupHostedFieldsClient()}.bind(this),50))))},teardownHostedFields:function(callbackFn){void 0!==this._hostedIntegration&&!1!==this._hostedIntegration?this._hostedIntegration.teardown(function(){this._hostedIntegration=!1,"function"==typeof callbackFn&&callbackFn()}.bind(this)):"function"==typeof callbackFn&&callbackFn()},setupHostedFieldsClient:function(){if(0<$$('iframe[name^="braintree-"]').length)return!1;this._hostedIntegration=!1,this.checkSubmitAfterPayment(),this.getClient(function(clientInstance){var options={client:clientInstance,styles:this.getHostedFieldsStyles(),fields:{number:{selector:"#card-number",placeholder:"0000 0000 0000 0000"},expirationMonth:{selector:"#expiration-month",placeholder:"MM"},expirationYear:{selector:"#expiration-year",placeholder:"YY"}}};null!==$("cvv")&&(options.fields.cvv={selector:"#cvv"}),braintree.hostedFields.create(options,function(hostedFieldsErr,hostedFieldsInstance){if(!hostedFieldsErr)return this.hostedFieldsOnReady(hostedFieldsInstance);"HOSTED_FIELDS_FIELD_DUPLICATE_IFRAME"!=hostedFieldsErr.code&&console.error(hostedFieldsErr)}.bind(this))}.bind(this))},hostedFieldsOnReady:function(integration){this._hostedIntegration=integration,$$("#credit-card-form.loading").length&&$$("#credit-card-form.loading").first().removeClassName("loading"),this.checkSubmitAfterPayment(),integration.on("cardTypeChange",this.hostedFieldsCardTypeChange.bind(this))},checkSubmitAfterPayment:function(){if(this.integration.submitAfterPayment){if(null==$("braintree-submit-after-payment")){var input=new Element("input",{type:"hidden",name:"payment[submit_after_payment]",value:1,id:"braintree-submit-after-payment"});$("payment_form_gene_braintree_creditcard").insert(input)}}else $("braintree-submit-after-payment")&&$("braintree-submit-after-payment").remove()},getHostedFieldsStyles:function(){return"function"==typeof this.integration.getHostedFieldsStyles?this.integration.getHostedFieldsStyles():{input:{"font-size":"14pt",color:"#3A3A3A"},":focus":{color:"black"},".valid":{color:"green"},".invalid":{color:"red"}}},hostedFieldsCardTypeChange:function(event){if(void 0!==event.cards){var cardMapping={visa:"VI","american-express":"AE","master-card":"MC",discover:"DI",jcb:"JCB",maestro:"ME"};void 0!==typeof cardMapping[event.cards[0].type]?(this.cardType=cardMapping[event.cards[0].type],this.updateCardType(!1,this.cardType),-1==this.supportedCards.indexOf(this.cardType)?this.showCardUnsupported():this.removeCardUnsupported()):(this.removeCardUnsupported(),this.cardType=!1,this.updateCardType(!1,"card"))}},showCardUnsupported:function(){if(0<$$(".braintree-card-input-field").length){var parentElement=$$(".braintree-card-input-field").first().up();if(0==parentElement.select(".braintree-card-unsupported").length){var error=new Element("div",{class:"braintree-card-unsupported"}).update(Translator.translate("We're currently unable to process this card type, please try another card or payment method."));parentElement.insert(error)}}},removeCardUnsupported:function(){0<$$(".braintree-card-unsupported").length&&$$(".braintree-card-unsupported").each(function(ele){ele.remove()})},getBillingCountryId:function(){if(null==$("billing-address-select")||""==$("billing-address-select").value){var billing=this.getBillingAddress();if(void 0!==billing["billing[country_id]"])return billing["billing[country_id]"]}return!!this.billingCountryId&&this.billingCountryId},shouldInvokeThreeDSecure:function(){var countryId;if(this.threeDSpecificCountries&&0<this.threeDCountries.length&&(countryId=this.getBillingCountryId()))return-1!==this.threeDCountries.indexOf(countryId);return this.threeDSecure},hostedFieldsNonceReceived:function(nonce,options){this.shouldInvokeThreeDSecure()?("function"==typeof this.integration.setLoading&&this.integration.setLoading(),this.verify3dSecureNonce(nonce,{onSuccess:function(response){this.updateNonce(response.nonce),"function"==typeof options.onSuccess&&options.onSuccess()}.bind(this),onFailure:function(){"function"==typeof options.onFailure&&options.onFailure()}.bind(this)})):(this.updateNonce(nonce),"function"==typeof options.onSuccess&&options.onSuccess())},updateNonce:function(nonce){$("creditcard-payment-nonce").value=nonce,$("creditcard-payment-nonce").setAttribute("value",nonce),"function"==typeof this.integration.resetLoading&&this.integration.resetLoading(),this._hostedFieldsTokenGenerated=!0},hostedFieldsError:function(response){return"function"==typeof this.integration.resetLoading&&this.integration.resetLoading(),void 0!==response.message&&-1==response.message.indexOf("Cannot place two elements in")&&-1==response.message.indexOf("Unable to find element with selector")&&-1==response.message.indexOf("User did not enter a payment method")&&alert(response.message),this._hostedFieldsTokenGenerated=!1,"function"==typeof this.integration.afterHostedFieldsError&&this.integration.afterHostedFieldsError(response.message),!1},usingSavedCard:function(){return null!=$("creditcard-saved-accounts")&&null!=$$("#creditcard-saved-accounts input:checked[type=radio]").first()&&"other"!==$$("#creditcard-saved-accounts input:checked[type=radio]").first().value},usingSavedThreeDCard:function(){return this.usingSavedCard()&&$$("#creditcard-saved-accounts input:checked[type=radio]").first().hasAttribute("data-threedsecure-nonce")},setThreeDSecure:function(flag){this.threeDSecure=flag},setAmount:function(amount){this.amount=parseFloat(amount)},setBillingName:function(billingName){this.billingName=billingName},getBillingName:function(){return"object"==typeof this.billingName?this.combineElementsValues(this.billingName):this.billingName},setBillingPostcode:function(billingPostcode){this.billingPostcode=billingPostcode},getBillingPostcode:function(){if("string"==typeof this.billingPostcode)return this.billingPostcode;if("object"==typeof this.billingPostcode)return this.combineElementsValues(this.billingPostcode);var billing=this.getBillingAddress();return void 0!==billing["billing[postcode]"]?billing["billing[postcode]"]:null},setAcceptedCards:function(cards){this.acceptedCards=cards},getBillingAddress:function(){if("function"==typeof this.integration.getBillingAddress)return this.integration.getBillingAddress();var billingAddress={};return null!==$("co-billing-form")?billingAddress="FORM"==$("co-billing-form").tagName?$("co-billing-form").serialize(!0):this.extractBilling($("co-billing-form").up("form").serialize(!0)):null!==$("billing:firstname")&&(billingAddress=this.extractBilling($("billing:firstname").up("form").serialize(!0))),billingAddress||void 0},extractBilling:function(formData){var billing={};return $H(formData).each(function(data){0==data.key.indexOf("billing")&&-1==data.key.indexOf("password")&&(billing[data.key]=data.value)}),billing},getAcceptedCards:function(){return this.acceptedCards},combineElementsValues:function(elements,seperator){seperator||(seperator=" ");var response=[];return elements.each(function(element,index){void 0!==$(element)&&(response[index]=$(element).value)}),response.join(seperator)},updateCardType:function(cardNumber,cardType){if(null!=$("card-type-image")){var skinImageUrl=$("card-type-image").src.substring(0,$("card-type-image").src.lastIndexOf("/"));$("card-type-image").setAttribute("src",skinImageUrl+"/"+cardType+".png")}},observeAjaxRequests:function(callback,ignore){if(vZero.prototype.observingAjaxRequests)return!1;vZero.prototype.observingAjaxRequests=!0,Ajax.Responders.register({onComplete:function(transport){return this.handleAjaxRequest(transport.url,callback,ignore)}.bind(this)}),window.jQuery&&jQuery(document).ajaxComplete(function(event,xhr,settings){return this.handleAjaxRequest(settings.url,callback,ignore)}.bind(this))},handleAjaxRequest:function(url,callback,ignore){if(void 0!==ignore&&ignore instanceof Array&&0<ignore.length){var shouldIgnore=!1;if(ignore.each(function(element){url&&-1!=url.indexOf(element)&&(shouldIgnore=!0)}),!0===shouldIgnore)return!1}url&&-1==url.indexOf("/braintree/")&&(this.fireEvent(this,"onHandleAjaxRequest",{url:url}),callback?callback(url):this.updateData())},updateData:function(callback,params){this._updateDataCallbacks.push(callback),clearTimeout(this._updateDataTimeout),this._updateDataTimeout=setTimeout(function(){var callbacks=this._updateDataCallbacks;this._updateDataCallbacks=[],this.fireEvent(this,"onBeforeUpdateData",{params:params}),new Ajax.Request(this.quoteUrl,{method:"post",parameters:params,onSuccess:function(transport){if(transport&&(transport.responseJSON||transport.responseText)){var response=this._parseTransportAsJson(transport);null!=response.billingName&&(this.billingName=response.billingName),null!=response.billingPostcode&&(this.billingPostcode=response.billingPostcode),null!=response.billingCountryId&&(this.billingCountryId=response.billingCountryId),null!=response.grandTotal&&(this.amount=response.grandTotal),null!=response.threeDSecure&&this.setThreeDSecure(response.threeDSecure),"undefined"!=typeof vzeroPaypal&&null!=response.grandTotal&&null!=response.currencyCode&&vzeroPaypal.setPricing(response.grandTotal,response.currencyCode),0<callbacks.length&&callbacks.each(function(callback){callback(response)}.bind(this)),this.fireEvent(this,"onAfterUpdateData",{response:response})}}.bind(this),onFailure:function(){}.bind(this)})}.bind(this),250)},tokenize3dSavedCards:function(callback){if(this.threeDSecure)if(void 0!==$$("[data-token]").first()){var tokens=[];$$("[data-token]").each(function(element,index){tokens[index]=element.getAttribute("data-token")}),new Ajax.Request(this.tokenizeUrl,{method:"post",onSuccess:function(transport){if(transport&&(transport.responseJSON||transport.responseText)){var response=this._parseTransportAsJson(transport);response.success&&$H(response.tokens).each(function(element){null!=$$('[data-token="'+element.key+'"]').first()&&$$('[data-token="'+element.key+'"]').first().setAttribute("data-threedsecure-nonce",element.value)}),callback&&callback(response)}}.bind(this),parameters:{tokens:Object.toJSON(tokens)}})}else callback();else callback()},verify3dSecureNonce:function(nonce,options){this.getClient(function(clientInstance){braintree.threeDSecure.create({client:clientInstance},function(threeDSecureError,threeDSecureInstance){if(threeDSecureError)console.error(threeDSecureError);else{var verifyOptions={amount:this.amount,nonce:nonce,addFrame:function(err,iframe){$$("#three-d-modal .bt-modal-body").first().insert(iframe),$("three-d-modal").removeClassName("hidden")},removeFrame:function(){$$("#three-d-modal .bt-modal-body iframe").first().remove(),$("three-d-modal").addClassName("hidden")}.bind(this)};threeDSecureInstance.verifyCard(verifyOptions,function(verifyError,payload){verifyError?options.onFailure&&options.onFailure(payload,verifyError):payload.liabilityShifted?options.onSuccess&&options.onSuccess(payload):"AE"===this.cardType?options.onSuccess&&options.onSuccess(payload):1==this.threeDSecureFailedAction?options.onFailure&&options.onFailure(payload,Translator.translate("Your payment has failed 3D secure verification, please try an alternate payment method.")):options.onSuccess&&options.onSuccess(payload)}.bind(this))}}.bind(this))}.bind(this))},verify3dSecureVault:function(options){var paymentNonce=$$("#creditcard-saved-accounts input:checked[type=radio]").first().getAttribute("data-threedsecure-nonce");paymentNonce?this.verify3dSecureNonce(paymentNonce,{onSuccess:function(response){$("creditcard-payment-nonce").removeAttribute("disabled"),$("creditcard-payment-nonce").value=response.nonce,$("creditcard-payment-nonce").setAttribute("value",response.nonce),"function"==typeof options.onSuccess&&options.onSuccess()},onFailure:function(response,error){alert(error),"function"==typeof options.onFailure?options.onFailure():checkout.setLoadWaiting(!1)}}):(alert("No payment nonce present."),"function"==typeof options.onFailure?options.onFailure():checkout.setLoadWaiting(!1))},processCard:function(options){var postcode=this.getBillingPostcode(),opt={};postcode&&(opt={billingAddress:{postalCode:postcode}}),this._hostedIntegration.tokenize(opt,function(tokenizeErr,payload){return tokenizeErr?("function"==typeof options.onFailure?options.onFailure():checkout.setLoadWaiting(!1),void("string"==typeof tokenizeErr.message&&alert(tokenizeErr.message))):this.hostedFieldsNonceReceived(payload.nonce,options)}.bind(this))},shouldInterceptCreditCard:function(){return"0.00"!=this.amount},shouldInterceptPayPal:function(){return!0},process:function(options){if(options=options||{},!(this._hostedFieldsTokenGenerated||this.usingSavedCard()&&!this.usingSavedThreeDCard()))return this.usingSavedThreeDCard()?this.verify3dSecureVault(options):this.processCard(options);"function"==typeof options.onSuccess&&options.onSuccess()},creditCardLoaded:function(){return!1},paypalLoaded:function(){return!1},_parseTransportAsJson:function(transport){return transport.responseJSON&&"object"==typeof transport.responseJSON?transport.responseJSON:transport.responseText?"object"==typeof JSON&&"function"==typeof JSON.parse?JSON.parse(transport.responseText):eval("("+transport.responseText+")"):{}}},function(){for(var method,noop=function(){},methods=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"],length=methods.length,console=window.console=window.console||{};length--;)console[method=methods[length]]||(console[method]=noop)}();
